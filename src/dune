(executables
  (public_names format lfs_write)
  (libraries cmdliner littlefs.fs mirage-block-unix lwt)
)

(rule
  (alias runtest)
  (action (progn
            (run dd if=/dev/zero of=test.img bs=64K count=1)
            (setenv OCAMLRUNPARAM b (run %{exe:format.exe} test.img))
            (run grep littlefs test.img)
            (run readmdir.py -a --log test.img 4096 0 1)
            (run readtree.py -a --log test.img 4096 0 1)
            ))
  )

(rule
  (alias write)
  (action (progn
            (run dd if=/dev/zero of=test.img bs=64K count=1)
            (setenv OCAMLRUNPARAM b (run %{exe:format.exe} test.img))
            (setenv OCAMLRUNPARAM b (run %{exe:lfs_write.exe} test.img 4096 "autoexec.bat" "CLS"))
            (setenv OCAMLRUNPARAM b (run %{exe:lfs_write.exe} test.img 4096 "config.sys" ""))
            (setenv OCAMLRUNPARAM b (run %{exe:lfs_write.exe} test.img 4096 "diary.txt" "Dear diary, today I ate cheese. It was great."))
            (run readtree.py -a --log test.img 4096 0 1)
            (run readmdir.py -a --log test.img 4096 0 1)
            ))
  )
