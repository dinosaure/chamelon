(executables
  (public_names format lfs_write lfs_read lfs_ls)
  (libraries bos cmdliner fpath littlefs.fs mirage-block-unix mirage-kv lwt)
)

(rule
  (alias runtest)
  (action (progn
            (run dd if=/dev/zero of=test.img bs=64K count=1)
            (setenv OCAMLRUNPARAM b (run %{exe:format.exe} test.img))
            (run grep littlefs test.img)
            (setenv OCAMLRUNPARAM b (run %{exe:lfs_write.exe} test.img 4096 "autoexec.bat" "CLS"))
            (setenv OCAMLRUNPARAM b (run %{exe:lfs_write.exe} test.img 4096 "config.sys" ""))
            (setenv OCAMLRUNPARAM b (run %{exe:lfs_write.exe} test.img 4096 "diary.txt" "Dear diary, today I ate cheese. It was great."))
            (setenv OCAMLRUNPARAM b (run %{exe:lfs_write.exe} test.img 4096 "secrets/mom_dont_look" "I SAID NOT TO LOOK JEEZ"))
            (setenv OCAMLRUNPARAM b (run %{exe:lfs_ls.exe} test.img 4096 "/"))
            (setenv OCAMLRUNPARAM b (run %{exe:lfs_read.exe} test.img 4096 "diary.txt"))
            (setenv OCAMLRUNPARAM b (run %{exe:lfs_read.exe} test.img 4096 "autoexec.bat"))
            (setenv OCAMLRUNPARAM b (run %{exe:lfs_read.exe} test.img 4096 "secrets/mom_dont_look"))
            (run dd if=/dev/urandom of=bigrandom bs=2K count=1)
            (setenv OCAMLRUNPARAM b (no-infer (with-stdin-from bigrandom (run %{exe:lfs_write.exe} test.img 4096 "important_stuff" -))))
            (setenv OCAMLRUNPARAM b (with-stdout-to important_stuff (run %{exe:lfs_read.exe} test.img 4096 "important_stuff")))
            (no-infer (diff bigrandom important_stuff))

  ))
)
